SET SERVEROUTPUT ON;

--1. Criar nova tabela EMP_VAGA_QTDE.
CREATE TABLE EMP_VAGA_QTDE (
    ID_EMP_VAGA_QTDE    NUMBER 
        GENERATED BY DEFAULT AS IDENTITY (INCREMENT BY 1) PRIMARY KEY,
    QTDE_HABILIDADE NUMBER(10) NOT NULL,
    VAGA_QTDE NUMBER,
    CONSTRAINT FK_QTDE_HABILIDADE
        FOREIGN KEY (QTDE_HABILIDADE)
        REFERENCES EMP_HABILIDADE (HABILIDADE_ID)
);

--2. Crie um Stored Procedure para inserir registros na tabela EMP_VAGA_QTDE
CREATE OR REPLACE PROCEDURE EMP_ADD_VAGA_QTDE (
    p_id_habilidade IN NUMBER
) AS
    V_QTDE NUMBER;
BEGIN
    SELECT COUNT(*)INTO V_QTDE
        FROM EMP_VAGA_HABILIDADE 
        WHERE HABILIDADE_ID = p_id_habilidade;
    
    DBMS_OUTPUT.PUT_LINE('Total de vagas: '||v_qtde);
    INSERT INTO EMP_VAGA_QTDE (QTDE_HABILIDADE, VAGA_QTDE)
        VALUES (p_id_habilidade, V_QTDE);
END;

EXEC EMP_ADD_VAGA_QTDE(2);


--3.Implementar um Stored Procedure que receba o ID de uma HABILIDADE e retorne 2 valores
CREATE OR REPLACE PROCEDURE GET_VAGA_MEDIA_SALARIAL (
    P_HABILIDADE_ID IN NUMBER,
    P_TOTAL_VAGAS OUT NUMBER,
    P_MEDIA_SALARIAL OUT NUMBER
) IS 
BEGIN   
    SELECT COUNT(*) INTO p_total_vagas
    FROM emp_vaga_habilidade VH
    JOIN EMP_VAGA V ON VH.VAGA_ID = V.VAGA_ID
    WHERE vh.habilidade_id = P_HABILIDADE_ID;
    
    DBMS_OUTPUT.PUT_LINE('Total de vagas: '|| p_total_vagas);
    
    SELECT AVG(V.VAGA_SALARIO) INTO 
    P_MEDIA_SALARIAL FROM EMP_VAGA_HABILIDADE VH
    JOIN EMP_VAGA V ON vh.vaga_id = v.vaga_id
    WHERE vh.habilidade_id = P_HABILIDADE_ID;
    DBMS_OUTPUT.PUT_LINE('A media é: '|| P_MEDIA_SALARIAL);
END;

DECLARE
    V_IN NUMBER;
    V_RES1 NUMBER;
    V_RES2 NUMBER;
    
BEGIN
    V_IN:= 2;
    V_RES1:= 0;
    V_RES2 := 0;
    GET_VAGA_MEDIA_SALARIAL (V_IN, V_RES1, V_RES2);
END;

--4 (2,0) - Implementar uma Stored Function que receba a chave primária (ID_USUARIO) 

CREATE OR REPLACE FUNCTION GET_TOTAL_VAGAS (
    p_id_usuario IN NUMBER
) RETURN NUMBER AS
    i NUMBER;
    qtde NUMBER := 0;
BEGIN
    SELECT COUNT(DISTINCT VAGA_ID) INTO QTDE
        FROM EMP_VAGA_HABILIDADE vh, EMP_PROFISSIONAL_HABILIDADE ph
        WHERE vh.habilidade_ID = ph.habilidade_id and
            PROFISSIONAL_USUARIO_ID = P_ID_USUARIO;

    RETURN QTDE;
END;

--5 (2,0) - Criar campo VAGAS_QTDE (NUMBER(5,0)) na tabela EMP_USUARIO
ALTER TABLE EMP_USUARIO
ADD VAGAS_QTDE NUMBER(5,0);

DECLARE
    V_ID_USUARIO NUMBER;
BEGIN
    V_ID_USUARIO:= 2;
    UPDATE EMP_USUARIO
        SET VAGAS_QTDE = GET_TOTAL_VAGAS(V_ID_USUARIO)
    WHERE USUARIO_ID = V_ID_USUARIO;
END;